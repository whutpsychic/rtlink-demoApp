import{y as F,z as V,b as m,ag as Y,N as R,C as P,ah as G,ai as H,ad as B,aj as J,d as M,ak as E,l as i,G as k,E as z,a3 as C,al as O,am as A,P as $,R as K,I as X,a5 as Q,B as I,an as Z,ao as ee,ap as j,_ as te,aq as ae,u as oe,g as D,o as S,h as U,w as N,c as ne,a as re,j as se,ar as ie,s as le,e as ce,f as W,as as ue}from"./index-c59e3292.js";import{a as de}from"./common-b417f748.js";const[ve,w]=F("image"),fe={src:String,alt:String,fit:String,position:String,round:Boolean,block:Boolean,width:k,height:k,radius:k,lazyLoad:Boolean,iconSize:k,showError:z,errorIcon:C("photo-fail"),iconPrefix:String,showLoading:z,loadingIcon:C("photo")};var me=V({name:ve,props:fe,emits:["load","error"],setup(a,{emit:l,slots:u}){const s=m(!1),t=m(!0),n=m(),{$Lazyload:d}=Y().proxy,y=R(()=>{const e={width:P(a.width),height:P(a.height)};return G(a.radius)&&(e.overflow="hidden",e.borderRadius=P(a.radius)),e});H(()=>a.src,()=>{s.value=!1,t.value=!0});const h=e=>{t.value&&(t.value=!1,l("load",e))},_=()=>{const e=new Event("load");Object.defineProperty(e,"target",{value:n.value,enumerable:!0}),h(e)},x=e=>{s.value=!0,t.value=!1,l("error",e)},g=(e,c,f)=>f?f():i(K,{name:e,size:a.iconSize,class:c,classPrefix:a.iconPrefix},null),b=()=>{if(t.value&&a.showLoading)return i("div",{class:w("loading")},[g(a.loadingIcon,w("loading-icon"),u.loading)]);if(s.value&&a.showError)return i("div",{class:w("error")},[g(a.errorIcon,w("error-icon"),u.error)])},v=()=>{if(s.value||!a.src)return;const e={alt:a.alt,class:w("img"),style:{objectFit:a.fit,objectPosition:a.position}};return a.lazyLoad?O(i("img",$({ref:n},e),null),[[A("lazy"),a.src]]):i("img",$({ref:n,src:a.src,onLoad:h,onError:x},e),null)},o=({el:e})=>{const c=()=>{e===n.value&&t.value&&_()};n.value?c():E(c)},r=({el:e})=>{e===n.value&&!s.value&&x()};return d&&B&&(d.$on("loaded",o),d.$on("error",r),J(()=>{d.$off("loaded",o),d.$off("error",r)})),M(()=>{E(()=>{var e;(e=n.value)!=null&&e.complete&&!a.lazyLoad&&_()})}),()=>{var e;return i("div",{class:w({round:a.round,block:a.block}),style:y.value},[v(),b(),(e=u.default)==null?void 0:e.call(u)])}}});const ge=X(me),[he,L,q]=F("signature"),_e={tips:String,type:C("png"),penColor:C("#000"),lineWidth:Z(3),clearButtonText:String,backgroundColor:C(""),confirmButtonText:String},xe=()=>{var a;const l=document.createElement("canvas");return!!((a=l.getContext)!=null&&a.call(l,"2d"))};var we=V({name:he,props:_e,emits:["submit","clear","start","end","signing"],setup(a,{emit:l}){const u=m(),s=m(),t=Q({width:0,height:0,ctx:null,ratio:B?window.devicePixelRatio:1});let n;const d=B?xe():!0,y=()=>{if(!t.ctx)return!1;t.ctx.beginPath(),t.ctx.lineWidth=a.lineWidth*t.ratio,t.ctx.strokeStyle=a.penColor,n=ee(u),l("start")},h=o=>{var r,e;if(!t.ctx)return!1;j(o);const c=o.touches[0],f=(c.clientX-((n==null?void 0:n.left)||0))*t.ratio,p=(c.clientY-((n==null?void 0:n.top)||0))*t.ratio;t.ctx.lineCap="round",t.ctx.lineJoin="round",(r=t.ctx)==null||r.lineTo(f,p),(e=t.ctx)==null||e.stroke(),l("signing",o)},_=o=>{j(o),l("end")},x=o=>{const r=document.createElement("canvas");return r.width=o.width,r.height=o.height,o.toDataURL()===r.toDataURL()},g=()=>{t.ctx&&a.backgroundColor&&(t.ctx.fillStyle=a.backgroundColor,t.ctx.fillRect(0,0,t.width,t.height))},b=()=>{var o,r;const e=u.value;if(!e)return;const f=x(e)?"":((r=(o={jpg:()=>e.toDataURL("image/jpeg",.8),jpeg:()=>e.toDataURL("image/jpeg",.8)})[a.type])==null?void 0:r.call(o))||e.toDataURL(`image/${a.type}`);l("submit",{image:f,canvas:e})},v=()=>{t.ctx&&(t.ctx.clearRect(0,0,t.width,t.height),t.ctx.closePath(),g()),l("clear")};return M(()=>{var o,r,e;d&&(t.ctx=(o=u.value)==null?void 0:o.getContext("2d"),t.width=(((r=s.value)==null?void 0:r.offsetWidth)||0)*t.ratio,t.height=(((e=s.value)==null?void 0:e.offsetHeight)||0)*t.ratio,E(()=>{g()}))}),()=>i("div",{class:L()},[i("div",{class:L("content"),ref:s},[d?i("canvas",{ref:u,width:t.width,height:t.height,onTouchstartPassive:y,onTouchmove:h,onTouchend:_},null):i("p",null,[a.tips])]),i("div",{class:L("footer")},[i(I,{size:"small",onClick:v},{default:()=>[a.clearButtonText||q("clear")]}),i(I,{type:"primary",size:"small",onClick:b},{default:()=>[a.confirmButtonText||q("confirm")]})])])}});const ye=X(we);const be={key:1,style:{height:"203px"}},pe={class:"btn-can"},Ce={__name:"main",setup(a){const l=ae(),u=oe(),s=m({}),t=m({}),n=m(""),d=R(()=>[{label:"登录密码",field:"oldPassWord",type:"text-field",mode:"password",placeholder:"请填写密码"},{label:"签章密码",field:"password",type:"text-field",mode:"password",placeholder:"请填写密码"},{label:"密码确认",field:"confirmPwd",type:"text-field",mode:"password",placeholder:"请填写密码"}]),y=R(()=>[[{required:!0,message:"请填写密码"}],[{required:!0,message:"请填写密码"}],[{required:!0,message:"请填写密码"}]]),h=v=>{},_=v=>{n.value=v.image},x=()=>{n.value=""},g=async()=>{const{password:v,confirmPwd:o}=s.value;return await s.value.validate()&&v===o},b=async()=>{if(!await g())return ie("密码确认不正确！");le({message:"保存中...",duration:0,forbidClick:!0}),de.uploadFile(n.value).then(o=>{const{success:r,fileId:e}=o,{oldPassWord:c,password:f,confirmPwd:p}=s.value;r&&ce.saveSignature({...t.value,fileId:e,oldPassWord:c,password:f,confirmPwd:p}).then(T=>{W(),ue("保存成功"),u.back()})}).finally(()=>{W()})};return t.value=l.query,(v,o)=>{const r=ye,e=ge,c=D("rtm-form"),f=I,p=D("rtm-app-container");return S(),U(p,{title:"我的签章",canPop:""},{body:N(()=>[i(r,{onSubmit:_,onClear:x,"clear-button-text":"重新签名"}),n.value?(S(),U(e,{key:0,src:n.value,height:"200"},null,8,["src"])):(S(),ne("div",be)),i(c,{ref_key:"form",ref:s,value:s.value,"onUpdate:value":[o[0]||(o[0]=T=>s.value=T),h],items:d.value,rules:y.value},null,8,["value","items","rules"]),re("div",pe,[i(f,{type:"primary",block:"",onClick:b,disabled:!n.value},{default:N(()=>[se("保存")]),_:1},8,["disabled"])])]),_:1})}}},Se=te(Ce,[["__scopeId","data-v-ae406d27"]]);export{Se as default};
